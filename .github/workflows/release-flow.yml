name: Release flow
on:
  workflow_dispatch:
    inputs:
      upstream_ref:
        description: "Druid ref (e.g. 33.0.0 or druid-33.0.0)"
        required: true

permissions:
  contents: write

env:
  JAVA_VERSION: "11"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      druid_version: ${{ steps.norm.outputs.druid_version }}
      druid_tag:     ${{ steps.norm.outputs.druid_tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Normalize upstream ref
        id: norm
        shell: bash
        run: |
          set -euo pipefail
          REF="${{ inputs.upstream_ref }}"
          if [[ "$REF" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VER="$REF"; TAG="druid-$REF"
          else
            VER="${REF#druid-}"; TAG="$REF"
          fi
          echo "druid_version=$VER" >> "$GITHUB_OUTPUT"
          echo "druid_tag=$TAG"     >> "$GITHUB_OUTPUT"

      - name: Run MSQ unit tests
        run: mvn -B -ntp clean test

      - name: Package MSQ jars
        run: |
          set -euo pipefail
          VER="${{ steps.norm.outputs.druid_version }}"
          mkdir -p dist
          mvn -q -DskipTests package
          find . -type f -path "*/target/druid-multi-stage-query-${VER}.jar" -not -path "./external-druid/*" -exec cp -n {} dist \; || true
          ls -l dist || true

      - name: Sparse checkout apache/druid@ref
        run: |
          set -e
          rm -rf external-druid
          git init external-druid
          git -C external-druid remote add origin https://github.com/apache/druid.git
          git -C external-druid config core.sparseCheckout true
          {
            echo "web-console/"
            echo "licenses/"
            echo "codestyle/"
            echo "docs/"
          } > external-druid/.git/info/sparse-checkout
          git -C external-druid fetch --depth 1 origin "${{ steps.norm.outputs.druid_tag }}" || git -C external-druid fetch --depth 1 origin "refs/tags/${{ steps.norm.outputs.druid_tag }}"
          git -C external-druid checkout --detach FETCH_HEAD
          [ -d external-druid/codestyle ] && mv external-druid/codestyle external-druid/web-console/
          [ -d external-druid/licenses ] && mv external-druid/licenses external-druid/web-console/

      - name: Apply web-console patch
        shell: bash
        run: |
          set -euo pipefail
          PATCH="$(git rev-parse --show-toplevel)/.github/patches/web-console.patch"
          [ -s "$PATCH" ] || { echo "::error ::patch missing/empty"; exit 1; }
          echo "Applying $PATCH ..."
          git -C external-druid apply --check "$PATCH"
          git -C external-druid apply --stat "$PATCH"
          git -C external-druid apply --reject --whitespace=nowarn "$PATCH"
          REJ=$(find external-druid -name "*.rej" | wc -l | tr -d ' ')
          if [ "$REJ" -gt 0 ]; then
            echo "::error title=Patch rejects::${REJ} hunk(s) failed"
            find external-druid -name "*.rej" -o -name "*.orig" -print
            exit 1
          fi
          echo "Patch applied cleanly."

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Web-console unit tests
        working-directory: external-druid/web-console
        run: |
          set -e
          npm ci --no-audit --no-fund
          script/create-sql-docs.mjs
          npx jest --ci

      - name: Package Web-Console jars
        working-directory: external-druid/web-console
        run: |
          VER="${{ steps.norm.outputs.druid_version }}"
          mvn -q -DskipTests -Dpmd.skip=true clean package
          cp target/web-console-${VER}.jar "$GITHUB_WORKSPACE/dist/"
          ls -l "$GITHUB_WORKSPACE/dist/"

      - name: Create RC draft release (unique tag per run) and upload jars
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VER="${{ steps.norm.outputs.druid_version }}"
          TMP_TAG="staging-${VER}-${{ github.run_id }}"
          TITLE="RC ${VER} (run ${{ github.run_number }})"
          gh release create "$TMP_TAG" --draft --title "$TITLE" --target "${GITHUB_SHA}" --notes "Automated RC draft"
          gh release upload "$TMP_TAG" dist/web-console-${VER}.jar dist/druid-multi-stage-query-${VER}.jar --clobber  

      - name: Install Chrome for IT
        id: chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Provision Druid, run integration tests
        id: it
        shell: bash
        run: |
          set -euo pipefail
          chmod +x .github/tools/provision-run-it.sh
          .github/tools/provision-run-it.sh \
            "${{ steps.norm.outputs.druid_version }}" \
            "$PWD/dist"

      - name: Create release branch, undraft, retag, clean tmp tag
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VER="${{ steps.norm.outputs.druid_version }}"
          TMP_TAG="staging-${VER}-${{ github.run_id }}"
          FINAL_TAG="release-${VER}"
          
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin
          git push origin "HEAD:refs/heads/release/${VER}"
          
          gh release edit "$TMP_TAG" --tag "$FINAL_TAG" --draft=false --title "Release ${VER}"
          
          git push origin ":refs/tags/${TMP_TAG}" || true